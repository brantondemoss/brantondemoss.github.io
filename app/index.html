<!DOCTYPE html>
<html>
  <head>
    <title>ilikeyou</title>
    <meta charset="UTF-8">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.5.0.min.js"></script>
  </head>
  <style>
    p {
    width: 4%;
    margin: 0px;
    }

    p .img {
    display: block;
    }
  </style>
  <body>
    <script>

      var thisid = 0;
      
      function statusChangeCallback(response) {
      console.log('statusChangeCallback');
      console.log(response);
      // The response object is returned with a status field that lets the
      // app know the current login status of the person.
      // Full docs on the response object can be found in the documentation
      // for FB.getLoginStatus().
      if (response.status === 'connected') {
      // Logged into your app and Facebook.
      testAPI();
      } else if (response.status === 'not_authorized') {
      // The person is logged into Facebook, but not your app.
      document.getElementById('status').innerHTML = 'Please log ' +
      'into this app.';
      } else {
      // The person is not logged into Facebook, so we're not sure if
      // they are logged into this app or not.
      document.getElementById('status').innerHTML = 'Please log ' +
      'into Facebook.';
      }
      }

      // This function is called when someone finishes with the Login
      // Button.  See the onlogin handler attached to it in the sample
      // code below.
      function checkLoginState() {
      FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
      });
      }

      window.fbAsyncInit = function() {
      FB.init({
      appId      : '626970334105962',
      cookie     : true,  // enable cookies to allow the server to access
      // the session
      xfbml      : true,  // parse social plugins on this page
      version    : 'v2.2' // use version 2.2
      });

      // Now that we've initialized the JavaScript SDK, we call
      // FB.getLoginStatus().  This function gets the state of the
      // person visiting this page and can return one of three states to
      // the callback you provide.  They can be:
      //
      // 1. Logged into your app ('connected')
      // 2. Logged into Facebook, but not your app ('not_authorized')
      // 3. Not logged into Facebook and can't tell if they are logged into
      //    your app or not.
      //
      // These three cases are handled in the callback function.

      FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
      });

      };

      // Load the SDK asynchronously
      (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));

      // Here we run a very simple test of the Graph API after login is
      // successful.  See statusChangeCallback() for when this call is made.
      function testAPI() {
      console.log('Welcome!  Fetching your information.... ');
      FB.api('/me', function(response) {
      console.log('Successful login for: ' + response.name);
      thisid = response.id;
      console.log('UserId is: ' + response.id);
      document.getElementById('status').innerHTML =
      'Thanks for logging in, ' + response.name + '!';
      ParseShit();
      });
      
      function getPic(userid)
      {
          FB.api("/"+userid+"/picture", function(response)
                 { return response});
      }

      FB.api(
      "/me/friends?limit=5000",
      function (response) {
      if(response && !response.error) {
      /* handle the result */
      console.log(response.data);
      console.log("Number of friends is " + response.data.length);
      console.log("Friend 0 is " + response.data[0]["name"]);
      document.getElementById("friendlist");
      var para = document.createElement("p");
      //para.innerHTML = "Everybody knows Iâ€™m known for dropping science.";
      friendlist.appendChild(para);

      for(var i=0;i<response.data.length;i++){
             
             var obj = response.data[i];
             var name = obj["name"];
             
             console.log("Catch 1");
             
             var checkbox = document.createElement('input');
             
             console.log("Catch 2");
             
             checkbox.type = "checkbox";
             checkbox.name = name;
             checkbox.value = "value";
             checkbox.id = "poop";
             
             var label = document.createElement('label')
             label.htmlFor = "poop";
             label.appendChild(document.createTextNode('text for label after checkbox'));
             
             container.appendChild(checkbox);
             container.appendChild(label);
             
		      
		      var img = document.createElement('img');
              img.src = getPic(obj["id"]);
		      document.getElementById('friendlist').appendChild(img);
		      
		      }

		      }
		      });
		      }
    
    
       function ParseShit(){
		      Parse.initialize("RSM1g2L24BVOdWoZsmc8epia5sUKI8RKLxd46Qhi", "hUujmDc4i7fOmwuLrAnIexV6QoGjJYaLrbyRenTc");
              
              console.log("thisid: " + thisid);
              
              thisid = parseInt(thisid);
		      
		      var FBUser = Parse.Object.extend("FBUser");
              var user;
		      var query = new Parse.Query(FBUser);
		      
		      query.equalTo("fbid", thisid);
		      
		      query.find({
		      success: function(baseuser)
		      {
                    if(baseuser.length == 1)
                         {
                            console.log("Succesfully found one existing user.");
                            console.log(baseuser);
                            user = baseuser[0];
                         }
                    else if(baseuser.length > 1)
                         {
                            console.log("Found multiple users... wat");
                         }
                    else
                         {
                            console.log("We got a new one.")
                            user = new FBUser();
                            user.set("fbid",thisid);
                            user.save(null, {
                                   success: function(user){
                                   console.log("Successfully registered new user.");
                                   },
                                   error: function(user, error){
                                   console.log("Failure to save. Error message: " + error.message + " " + error.code);
                                   }
                            });
                         }
                },
                error: function(object,error)
                {
                         console.log("Major malfunction in query request " + error.code + ": " + error.message);
                }});
       }
	
		      </script>

        <!--
  Below we include the Login Button social plugin. This button uses
  the JavaScript SDK to present a graphical Login button that triggers
  the FB.login() function when clicked.
	  -->

	<fb:login-button scope="public_profile,email,user_friends" onlogin="checkLoginState();">
	</fb:login-button>

	<div id="status">
	</div>
	<div id="friendlist">

	</div>

  </body>
</html>
